<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Enhanced 3D Drone Website with Aerial Movement & Linux Terminal Lab
    </title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css"
    />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      canvas {
        display: block;
      }
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        color: white;
        z-index: 100;
        pointer-events: none;
      }
      #pointerList {
        position: absolute;
        right: 10px;
        top: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        z-index: 100;
      }
      #tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        display: none;
        z-index: 200;
      }
      #labInterface {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
        z-index: 300;
        width: 80%;
        max-width: 600px;
      }
      #terminal {
        background: black;
        color: white;
        font-family: monospace;
        padding: 10px;
        margin-top: 10px;
        height: 200px;
        overflow-y: auto;
        width: 100%;
        height: 300px;
        margin-top: 10px;
      }
      .lab-button {
        position: absolute;
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: none;
        z-index: 150;
      }
      #assignment-info {
        margin-top: 20px;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="info">
      Use WASD to move, Q/E to ascend/descend, mouse to look around. Click to
      start.
    </div>
    <div id="pointerList"></div>
    <div id="tooltip"></div>
    <div id="labInterface">
      <h2 id="labTitle"></h2>
      <p id="labDescription"></p>
      <div id="terminal"></div>
      <div id="assignment-info">
        <h3>Current Assignment: <span id="assignment-title"></span></h3>
        <p id="assignment-description"></p>
      </div>
      <button onclick="submitAssignment()">Submit Assignment</button>
      <button onclick="closeLab()">Close Lab</button>
    </div>
    <button id="startLab" class="lab-button">Start Lab</button>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.138.0/build/three.module.js",
          "three/examples/jsm/controls/PointerLockControls": "https://unpkg.com/three@0.138.0/examples/jsm/controls/PointerLockControls.js"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/addons/fit/fit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script type="module">
      import * as THREE from "three";
      import { PointerLockControls } from "three/examples/jsm/controls/PointerLockControls";

      let scene, camera, renderer, controls;
      let moveForward = false,
        moveBackward = false,
        moveLeft = false,
        moveRight = false,
        moveUp = false,
        moveDown = false;
      let prevTime = performance.now();
      const velocity = new THREE.Vector3();
      const direction = new THREE.Vector3();
      let pointers = [];
      let buildings = [];
      let labPointers = [];
      let currentLab = null;
      let term;
      let currentLine = "";
      let pointerReferenceList;

      // Terminal and assignment-related variables
      let currentAssignment = null;
      const assignments = [
        {
          title: "Hello World",
          description:
            "Write a Python program that prints 'Hello, World!' to the console.",
          startCode: "# Write your code here\n\n",
          solution: 'print("Hello, World!")',
          test: (output) => output.trim() === "Hello, World!",
        },
        {
          title: "Sum of Two Numbers",
          description:
            "Write a Python function that takes two numbers as input and returns their sum.",
          startCode:
            "def sum_two_numbers(a, b):\n    # Write your code here\n    pass\n\n# Test your function\nprint(sum_two_numbers(3, 4))",
          solution:
            "def sum_two_numbers(a, b):\n    return a + b\n\nprint(sum_two_numbers(3, 4))",
          test: (output) => output.trim() === "7",
        },
      ];

      init();
      animate();

      function createQuickReferenceList() {
        pointerReferenceList = document.createElement("div");
        pointerReferenceList.id = "pointerReferenceList";
        pointerReferenceList.style.cssText = `
        position: fixed;
        right: 20px;
        top: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000;
      `;
        document.body.appendChild(pointerReferenceList);
      }

      function createPointers() {
        // Modify the pointer creation code
        const contentTexts = [
          "Welcome to the future of drone technology!",
          "Explore the city from a bird's eye view.",
          "Discover hidden gems in the urban landscape.",
          "Experience the thrill of drone flight.",
          "Navigate through the concrete jungle.",
        ];
        for (let i = 0; i < contentTexts.length; i++) {
          const pointerGeometry = new THREE.SphereGeometry(1, 32, 32);
          const pointerMaterial = new THREE.MeshPhongMaterial({
            color: 0x00ff00,
            emissive: 0x00ff00,
            emissiveIntensity: 0.5,
            transparent: true,
            opacity: 0.8,
          });
          const pointer = new THREE.Mesh(pointerGeometry, pointerMaterial);

          const randomBuilding =
            buildings[Math.floor(Math.random() * buildings.length)];
          pointer.position.set(
            randomBuilding.position.x,
            randomBuilding.position.y +
              randomBuilding.geometry.parameters.height / 2 +
              2,
            randomBuilding.position.z
          );

          pointer.userData.content = contentTexts[i];
          pointer.userData.index = i;

          scene.add(pointer);
          pointers.push(pointer);

          // Add pulsing animation
          const pulseAnimation = new THREE.AnimationClip("pulse", 1, [
            new THREE.VectorKeyframeTrack(
              ".scale",
              [0, 0.5, 1],
              [1, 1, 1, 1.2, 1.2, 1.2, 1, 1, 1]
            ),
          ]);
          const mixer = new THREE.AnimationMixer(pointer);
          const action = mixer.clipAction(pulseAnimation);
          action.play();
          pointer.userData.mixer = mixer;

          // Add to quick reference list
          const listItem = document.createElement("div");
          listItem.textContent = `Pointer ${i + 1}: ${contentTexts[i].substring(
            0,
            20
          )}...`;
          listItem.style.cursor = "pointer";
          listItem.style.marginBottom = "5px";
          listItem.onclick = () => focusOnPointer(pointer);
          pointerReferenceList.appendChild(listItem);
        }
      }

      function createLabPointers() {
        const labExperiments = [
          {
            title: "Python Basics Lab",
            description: "Learn and practice Python programming basics.",
          },
          {
            title: "Advanced Python Lab",
            description: "Explore advanced Python concepts and algorithms.",
          },
        ];

        for (let i = 0; i < labExperiments.length; i++) {
          const labPointerGeometry = new THREE.SphereGeometry(1, 32, 32);
          const labPointerMaterial = new THREE.MeshPhongMaterial({
            color: 0xff0000,
            emissive: 0xff0000,
            emissiveIntensity: 0.5,
            transparent: true,
            opacity: 0.8,
          });
          const labPointer = new THREE.Mesh(
            labPointerGeometry,
            labPointerMaterial
          );

          const randomBuilding =
            buildings[Math.floor(Math.random() * buildings.length)];
          labPointer.position.set(
            randomBuilding.position.x,
            randomBuilding.position.y +
              randomBuilding.geometry.parameters.height / 2 +
              2,
            randomBuilding.position.z
          );

          labPointer.userData.experiment = labExperiments[i];
          labPointer.userData.index = i;

          scene.add(labPointer);
          labPointers.push(labPointer);

          // Add pulsing animation
          const pulseAnimation = new THREE.AnimationClip("pulse", 1, [
            new THREE.VectorKeyframeTrack(
              ".scale",
              [0, 0.5, 1],
              [1, 1, 1, 1.2, 1.2, 1.2, 1, 1, 1]
            ),
          ]);
          const mixer = new THREE.AnimationMixer(labPointer);
          const action = mixer.clipAction(pulseAnimation);
          action.play();
          labPointer.userData.mixer = mixer;

          // Add to quick reference list
          const listItem = document.createElement("div");
          listItem.textContent = `Lab ${i + 1}: ${labExperiments[i].title}`;
          listItem.style.cursor = "pointer";
          listItem.style.marginBottom = "5px";
          listItem.onclick = () => focusOnPointer(labPointer);
          pointerReferenceList.appendChild(listItem);
        }
      }

      function focusOnPointer(pointer) {
        const offset = new THREE.Vector3(0, 5, 20);
        const targetPosition = pointer.position.clone().add(offset);

        new TWEEN.Tween(camera.position)
          .to(targetPosition, 1000)
          .easing(TWEEN.Easing.Cubic.InOut)
          .start();

        new TWEEN.Tween(controls.target)
          .to(pointer.position, 1000)
          .easing(TWEEN.Easing.Cubic.InOut)
          .start();
      }

      function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xcccccc, 0.002);

        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.y = 50;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Improved lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(100, 100, 50);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 1;
        directionalLight.shadow.camera.far = 500;
        directionalLight.shadow.camera.left = -200;
        directionalLight.shadow.camera.right = 200;
        directionalLight.shadow.camera.top = 200;
        directionalLight.shadow.camera.bottom = -200;
        scene.add(directionalLight);

        // Ground
        const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
        const groundTexture = new THREE.TextureLoader().load(
          "https://threejsfundamentals.org/threejs/resources/images/checker.png"
        );
        groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
        groundTexture.repeat.set(100, 100);
        const groundMaterial = new THREE.MeshPhongMaterial({
          map: groundTexture,
          side: THREE.DoubleSide,
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Buildings
        const buildingTexture = new THREE.TextureLoader().load(
          "https://threejsfundamentals.org/threejs/resources/images/wall.jpg"
        );
        buildingTexture.wrapS = buildingTexture.wrapT = THREE.RepeatWrapping;
        buildingTexture.repeat.set(1, 1);

        for (let i = 0; i < 100; i++) {
          const buildingHeight = Math.random() * 80 + 20;
          const buildingWidth = Math.random() * 20 + 10;
          const buildingDepth = Math.random() * 20 + 10;
          const buildingGeometry = new THREE.BoxGeometry(
            buildingWidth,
            buildingHeight,
            buildingDepth
          );
          const buildingMaterial = new THREE.MeshPhongMaterial({
            map: buildingTexture,
            color: new THREE.Color(
              Math.random() * 0.1 + 0.7,
              Math.random() * 0.1 + 0.7,
              Math.random() * 0.1 + 0.7
            ),
          });
          const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
          building.position.set(
            Math.random() * 400 - 200,
            buildingHeight / 2,
            Math.random() * 400 - 200
          );
          building.castShadow = true;
          building.receiveShadow = true;
          scene.add(building);
          buildings.push(building);
        }

        // Skybox
        // const skyboxGeometry = new THREE.BoxGeometry(1000, 1000, 1000);
        // const skyboxMaterials = [
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/px.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/nx.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/py.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/ny.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/pz.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        //   new THREE.MeshBasicMaterial({
        //     map: new THREE.TextureLoader().load(
        //       "https://threejsfundamentals.org/threejs/resources/images/skybox/nz.jpg"
        //     ),
        //     side: THREE.BackSide,
        //   }),
        // ];
        // const skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterials);
        // scene.add(skybox);
        createQuickReferenceList();
        createPointers();
        createLabPointers();

        controls = new PointerLockControls(camera, document.body);
        scene.add(controls.getObject());

        document.addEventListener("click", function () {
          controls.lock();
        });

        document.addEventListener("keydown", onKeyDown);
        document.addEventListener("keyup", onKeyUp);

        window.addEventListener("resize", onWindowResize);

        const startLabButton = document.getElementById("startLab");
        startLabButton.addEventListener("click", startLabExperiment);

        // Initialize xterm.js
        term = new Terminal({
          cursorBlink: true,
          theme: {
            background: "#000000",
            foreground: "#ffffff",
          },
          rows: 20,
          cols: 80,
        });
      }

      function onKeyDown(event) {
        switch (event.code) {
          case "KeyW":
            moveForward = true;
            break;
          case "KeyA":
            moveLeft = true;
            break;
          case "KeyS":
            moveBackward = true;
            break;
          case "KeyD":
            moveRight = true;
            break;
          case "KeyQ":
            moveUp = true;
            break;
          case "KeyE":
            moveDown = true;
            break;
        }
      }

      function onKeyUp(event) {
        switch (event.code) {
          case "KeyW":
            moveForward = false;
            break;
          case "KeyA":
            moveLeft = false;
            break;
          case "KeyS":
            moveBackward = false;
            break;
          case "KeyD":
            moveRight = false;
            break;
          case "KeyQ":
            moveUp = false;
            break;
          case "KeyE":
            moveDown = false;
            break;
        }
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      function showTooltip(content, x, y) {
        const tooltip = document.getElementById("tooltip");
        tooltip.style.display = "block";
        tooltip.style.left = x + "px";
        tooltip.style.top = y + "px";
        tooltip.textContent = content;
      }
      function hideTooltip() {
        const tooltip = document.getElementById("tooltip");
        tooltip.style.display = "none";
      }

      function startLabExperiment() {
        if (currentLab) {
          const labInterface = document.getElementById("labInterface");
          labInterface.style.display = "block";
          document.getElementById("labTitle").textContent = currentLab.title;
          document.getElementById("labDescription").textContent =
            currentLab.description;

          controls.unlock();

          term.open(document.getElementById("terminal"));
          Terminal.applyAddon(fit);
          term.fit();

          term.clear();
          term.writeln("Welcome to the Python Programming Lab");
          term.writeln('Type "help" for a list of available commands');
          term.writeln("");

          term.onKey(({ key, domEvent }) => {
            const printable =
              !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

            if (domEvent.keyCode === 13) {
              // Enter
              term.write("\r\n");
              handleCommand(currentLine);
              currentLine = "";
              term.write("$ ");
            } else if (domEvent.keyCode === 8) {
              // Backspace
              if (currentLine.length > 0) {
                currentLine = currentLine.slice(0, -1);
                term.write("\b \b");
              }
            } else if (printable) {
              currentLine += key;
              term.write(key);
            }
          });

          term.write("$ ");

          startAssignment();
        }
      }

      function handleCommand(command) {
        command = command.trim();
        switch (command.toLowerCase()) {
          case "help":
            term.writeln("Available commands:");
            term.writeln("  help - Show this help message");
            term.writeln("  clear - Clear the terminal");
            term.writeln("  ls - List files in the current directory");
            term.writeln("  cat [filename] - Display file contents");
            term.writeln("  python [filename] - Run a Python script");
            break;
          case "clear":
            term.clear();
            break;
          case "ls":
            term.writeln("assignment.py");
            break;
          case "cat assignment.py":
            if (currentAssignment) {
              term.writeln(currentAssignment.startCode);
            } else {
              term.writeln("No active assignment.");
            }
            break;
          case "python assignment.py":
            if (currentAssignment) {
              // In a real implementation, this would be executed in a containerized backend
              const output = eval(currentAssignment.solution);
              term.writeln(output);
            } else {
              term.writeln("No active assignment.");
            }
            break;
          default:
            term.writeln(`Command not found: ${command}`);
        }
      }

      function startAssignment() {
        currentAssignment =
          assignments[Math.floor(Math.random() * assignments.length)];
        document.getElementById("assignment-title").textContent =
          currentAssignment.title;
        document.getElementById("assignment-description").textContent =
          currentAssignment.description;
        term.writeln(`\r\nNew assignment started: ${currentAssignment.title}`);
        term.writeln(
          'Use "cat assignment.py" to view the assignment, and edit it using your preferred method.'
        );
        term.writeln('Run your code using "python assignment.py"');
        term.write("$ ");
      }

      function submitAssignment() {
        if (currentAssignment) {
          // In a real implementation, this would be executed in a containerized backend
          const output = eval(currentAssignment.solution);
          const passed = currentAssignment.test(output);
          if (passed) {
            term.writeln("\r\nAssignment passed! Great job!");
          } else {
            term.writeln("\r\nAssignment failed. Please try again.");
          }
        } else {
          term.writeln("\r\nNo active assignment to submit.");
        }
        term.write("$ ");
      }

      function closeLab() {
        const labInterface = document.getElementById("labInterface");
        labInterface.style.display = "none";
        controls.lock();
      }

      // function submitCommand() {
      //   const commandInput = document.getElementById("commandInput");
      //   const command = commandInput.value.trim().toLowerCase();
      //   const terminal = document.getElementById("terminal");

      //   terminal.innerHTML += `> ${command}<br>`;

      //   const task = currentLab.tasks.find((t) => t.command === command);
      //   if (task) {
      //     terminal.innerHTML += `${task.response}<br>`;
      //   } else {
      //     terminal.innerHTML += "Unknown command. Try again.<br>";
      //   }

      //   commandInput.value = "";
      //   terminal.scrollTop = terminal.scrollHeight;
      // }

      function animate() {
        requestAnimationFrame(animate);

        const time = performance.now();
        const delta = (time - prevTime) / 1000;

        // Update pointer animations
        pointers.forEach((pointer) => {
          if (pointer.userData.mixer) {
            pointer.userData.mixer.update(delta);
          }
        });

        labPointers.forEach((labPointer) => {
          if (labPointer.userData.mixer) {
            labPointer.userData.mixer.update(delta);
          }
        });

        // Update TWEEN
        TWEEN.update();

        velocity.x -= velocity.x * 5.0 * delta;
        velocity.y -= velocity.y * 5.0 * delta;
        velocity.z -= velocity.z * 5.0 * delta;

        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.y = Number(moveUp) - Number(moveDown);
        direction.normalize();

        const moveSpeed = 200.0;

        if (moveForward || moveBackward)
          velocity.z -= direction.z * moveSpeed * delta;
        if (moveLeft || moveRight)
          velocity.x -= direction.x * moveSpeed * delta;
        if (moveUp || moveDown) velocity.y += direction.y * moveSpeed * delta;

        controls.moveRight(-velocity.x * delta);
        controls.moveForward(-velocity.z * delta);

        // Move the camera up/down
        controls.getObject().position.y += velocity.y * delta;

        // Prevent going below ground level
        if (controls.getObject().position.y < 1) {
          velocity.y = 0;
          controls.getObject().position.y = 1;
        }

        let closestPointer = null;
        let closestDistance = Infinity;
        let closestLabPointer = null;
        let closestLabDistance = Infinity;

        pointers.forEach((pointer) => {
          const distance = controls
            .getObject()
            .position.distanceTo(pointer.position);
          if (distance < closestDistance) {
            closestDistance = distance;
            closestPointer = pointer;
          }
        });

        labPointers.forEach((labPointer) => {
          const distance = controls
            .getObject()
            .position.distanceTo(labPointer.position);
          if (distance < closestLabDistance) {
            closestLabDistance = distance;
            closestLabPointer = labPointer;
          }
        });

        if (closestDistance < 5 && closestPointer) {
          const screenPosition = closestPointer.position
            .clone()
            .project(camera);
          const x = (screenPosition.x * 0.5 + 0.5) * window.innerWidth;
          const y = (-(screenPosition.y * 0.5) + 0.5) * window.innerHeight;
          showTooltip(closestPointer.userData.content, x, y);
        } else if (closestLabDistance < 5 && closestLabPointer) {
          const screenPosition = closestLabPointer.position
            .clone()
            .project(camera);
          const x = (screenPosition.x * 0.5 + 0.5) * window.innerWidth;
          const y = (-(screenPosition.y * 0.5) + 0.5) * window.innerHeight;
          showTooltip(closestLabPointer.userData.experiment.title, x, y);

          const startLabButton = document.getElementById("startLab");
          startLabButton.style.display = "block";
          startLabButton.style.left = x + "px";
          startLabButton.style.top = y + 30 + "px";
          currentLab = closestLabPointer.userData.experiment;
        } else {
          hideTooltip();
          document.getElementById("startLab").style.display = "none";
          currentLab = null;
        }

        prevTime = time;

        renderer.render(scene, camera);
      }

      window.closeLab = closeLab;
    </script>
  </body>
</html>
